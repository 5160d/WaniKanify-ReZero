#!/bin/sh
# Husky v10 style hook (no legacy husky.sh shim). Fail fast on errors.
set -e

# 1. Lint (ESLint custom i18n rules + no raw console)
echo "[pre-commit] Running ESLint..."
pnpm lint

# 2. Unused localization key scan (must pass to commit)
echo "[pre-commit] Checking for unused localization keys..."
UNUSED_LOG="$(dirname "$0")/.cache_unused_keys.log"
if ! pnpm i18n:unused > "$UNUSED_LOG" 2>&1; then
	echo "[pre-commit] ❌ Unused localization keys detected:" >&2
	cat "$UNUSED_LOG" >&2
	echo "[pre-commit] To proceed: remove unused keys from locales/en/messages.json or add references." >&2
	echo "[pre-commit] (If performing a large refactor, temporarily bypass with --no-verify, but follow up with cleanup.)" >&2
	exit 1
fi

# 3. Run tests (full regression) - can be optimized later with changed files selection
echo "[pre-commit] Running Jest test suite..."
pnpm test -- --runInBand

echo "[pre-commit] All checks passed."